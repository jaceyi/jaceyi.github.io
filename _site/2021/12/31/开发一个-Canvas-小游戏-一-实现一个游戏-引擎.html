<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="keywords"
    content="jaceyi,yijinchun,Jace,JaceYi,Jace Yi,æ˜“è¿›æ˜¥,æ˜“è¿›æ˜¥çš„åšå®¢,yiä¸ªç¨‹åºçŒ¿,å‰ç«¯,å‰ç«¯å¼€å‘,å‰ç«¯åšå®¢,JavaScript,Canvas">
  <meta name="description" content="æ˜“è¿›æ˜¥çš„ä¸ªäººåšå®¢ï¼Œåˆ†äº«æ—¥å¸¸ç”Ÿæ´»ã€å­¦ä¹ ç¬”è®°å’Œè¸©è¿‡çš„é‚£äº›å‘~" />
  <title>å¼€å‘ä¸€ä¸ª Canvas å°æ¸¸æˆï¼ˆä¸€ï¼‰å®ç°ä¸€ä¸ªæ¸¸æˆâ€œå¼•æ“â€ - æ˜“è¿›æ˜¥çš„åšå®¢ã€Webå‰ç«¯å¼€å‘ã€‘</title>
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/css/prism.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/post.css">
  <script src="/js/util.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4613132254509352"
    crossorigin="anonymous"></script>
</head>

<body>
  <div id="header" style="background-image: url(/static/images/bg4.jpg)">
    <div class="bar">
  <div class="title">
    <a href="/">Jace's Blog</a>
  </div>
  <nav class="nav">
    <div class="item">
      <a href="/">Home</a>
    </div>
    <div class="item">
      <a href="/tags">Tags</a>
    </div>
    <div class="item">
      <a href="/about">About</a>
    </div>
  </nav>
  <div class="mobile-nav">
    <div class="mobile-nav-menu icon">
      <i class="iconfont">&#xe633;</i>
    </div>
    <div class="mobile-nav-box">
      <a href="/">Home</a>
      <a href="/tags">Tags</a>
      <a href="/about">About</a>
    </div>
  </div>
</div>

<script>
  (function (d, w) {
    w.onload = function () {
      var $menuIcon = d.querySelector('.mobile-nav-menu');
      var $navBox = d.querySelector('.mobile-nav-box');
      var animationEndCallback = null;
      function hideNavBox() {
        addClass($navBox, 'zoomOut');
        animationEndCallback = function () {
          removeClass($navBox, 'zoomOut');
          $navBox.style.display = 'none';
        }
      }

      $menuIcon.onclick = function (e) {
        e.stopPropagation();
        if ($navBox.style.display === 'block') return hideNavBox();
        $navBox.style.display = 'block';
        addClass($navBox, 'zoomIn');
        animationEndCallback = function () {
          removeClass($navBox, 'zoomIn');
        }
      };

      $navBox.onclick = function (e) {
        e.stopPropagation();
      };

      $navBox.addEventListener('animationend', function (e) {
        animationEndCallback && animationEndCallback();
      }, false);

      d.body.addEventListener('click', function () {
        if ($navBox.style.display === 'block') hideNavBox();
      }, false);

      var $header = d.querySelector('#header');
      var $bar = d.querySelector('.bar');
      var barHeight = $bar.offsetHeight;
      var prev = 0;
      w.addEventListener('scroll', function (e) {
        var scrollTop = d.documentElement.scrollTop || d.body.scrollTop;
        var step = $header.className.indexOf('visible') >= 0 ? barHeight : 0;
        if (scrollTop > $header.offsetHeight - step) {
          addClass($header, 'active');

          if (scrollTop > prev) {
            removeClass($header, 'visible');
          } else {
            addClass($header, 'visible');
          }
        } else {
          removeClass($header, ['active', 'visible']);
        }
        prev = scrollTop;
      }, false);
    }
  })(document, window);
</script>

    <div class="content">
      <h1 class="post-title">å¼€å‘ä¸€ä¸ª Canvas å°æ¸¸æˆï¼ˆä¸€ï¼‰å®ç°ä¸€ä¸ªæ¸¸æˆâ€œå¼•æ“â€</h1>
      <div class="post-description">å®ç°ä¸€ä¸ªç®€æ˜“çš„ Canvas 2D æ¸¸æˆâ€œå¼•æ“â€ï¼ŒåŒ…æ‹¬æ¸²æŸ“å™¨ã€ç…§ç›¸æœºã€å®ä½“ã€åœºæ™¯ç­‰ï¼Œè¿˜é’ˆå¯¹åŠ¨ç”»å¤„ç†å’Œäº‹ä»¶åšäº†ç®€å•çš„å°è£…ã€‚</div>
      <div class="post-date">2021-12-31</div>
      <div class="tags">
        
        <a class="tag" href="/tags/#JavaScript" title="JavaScript">JavaScript</a>
        
        <a class="tag" href="/tags/#Canvas" title="Canvas">Canvas</a>
        
      </div>
    </div>
  </div>

  <div class="container">
    <div class="article">
      <!--more-->

<h2 id="å‰è¨€">å‰è¨€</h2>

<blockquote>
  <p>å¥½ä¹…æ²¡å†™æ–‡ç« äº†ï¼Œæ€æ¥æƒ³å»æ„Ÿè§‰å„ç§ç±»å‹çš„æ–‡ç« ç½‘ä¸Šéƒ½ä¸€å¤§å †æ²¡æœ‰å†™çš„å¿…è¦ï¼Œä¹‹å‰æœ‰æƒ³è¦å¼„ä¸€ä¸ª hooks åº“åæ¥å‘ç° ahooks è¶Šæ¥è¶Šå®Œå–„ï¼Œä¹Ÿæ²¡å¿…è¦å¼„äº†ï¼Œçœ‹ç€å¿«è¿‡å¹´äº†æƒ³ç€æ€»ä¸èƒ½ä¸€å¹´é›¶äº§å‡ºï¼Œè¿˜æ˜¯çš„åŠªåŠªåŠ›ï¼ˆæ‰“ç®—çš„æ—©ï¼Œç»“æŸçš„æ™šï¼Œéƒ½åˆ° 12 æœˆ 31 äº†æ‰æƒ³èµ·æ¥è¿˜æœ‰ç¯‡æ–‡ç« æ²¡æœ‰å†™å®Œï¼‰ã€‚</p>
</blockquote>

<p>è¿™ä¸ªæ¸¸æˆå…¶å®åœ¨ä¸‰å››å¹´å‰å°±å†™äº†ï¼Œä¸­é—´è¿˜é‡æ„è¿‡å¥½å‡ æ¬¡ï¼Œä¹‹å‰éƒ½æ˜¯ç”¨ç®€å•çš„é¢å‘å¯¹è±¡å’Œå‡½æ•°å¼ç¼–ç¨‹æ¥å†™ï¼Œæ¸¸æˆä¸­çš„å…ƒç´ å…³ç³»åˆ°è¿˜æ˜¯åˆ†çš„æŒºå¼€ï¼Œä½†æ˜¯æ¸¸æˆçš„æ¸²æŸ“ï¼Œè¿ç®—ç­‰é€»è¾‘åˆ†çš„ä¸å¤Ÿæ¸…æ™°ï¼Œæ•´ä¸ªé€»è¾‘åŸºæœ¬éƒ½æ˜¯è‡ªé¡¶å‘ä¸‹çš„æµæ°´ä¸€æ ·ï¼Œä»Šå¹´åˆæŠ½ç©ºé‡æ„äº†ä¸€ç‰ˆï¼ŒæŠŠä¸€äº›äº‹ä»¶å¤„ç†ã€æ¸²æŸ“åŒ…æ‹¬åŠ¨ç”»å°è£…æˆä¸€ä¸ªâ€œå¼•æ“â€ï¼Œè¿™æ ·å†å†™ä¸€ä¸ªåˆ«çš„æ¸¸æˆä¹Ÿåªç”¨å†™æ¸¸æˆæœ¬èº«çš„é€»è¾‘ã€‚ï¼ˆä»¥ä¸‹å®ç°å…¨é çæ‰æ‘¸ï¼Œæˆ–è®¸å†æ¸¸æˆå¼€å‘é¢†åŸŸæœ‰å¾ˆå¤šæ›´é«˜çº§çš„ç©æ³•ï¼Œä½†æ˜¯å°±è¿™æ ·å§ ğŸ¥º ï¼‰ã€‚</p>

<p>å…ˆä¸Šä¸ªæ¸¸æˆåœ¨çº¿åœ°å€å§ï¼š<a href="https://snowball.jaceyi.com">https://snowball.jaceyi.com</a>Â ï¼Œå³ä¸Šè§’å¯ä»¥è®¾ç½®æ¸¸æˆæ“ä½œæ–¹å¼ï¼Œé»˜è®¤æ˜¯<strong>æ‹–æ‹½æ¨¡å¼</strong>ï¼Œæ‰‹æŒ‡æŒ‰ä¸‹å¹¶ç§»åŠ¨å°çƒä¼šå¾€æ‰‹æŒ‡ç§»åŠ¨çš„æ–¹å‘ç§»åŠ¨ï¼›è¿˜æœ‰ä¸ª<strong>åå‘æ¨¡å¼</strong>æ˜¯æ‰‹æŒ‡æŒ‰ä¸‹å°çƒå°±ä¼šæœå½“å‰ç§»åŠ¨æ–¹å‘çš„åæ–¹å‘è½¬åŠ¨ã€‚æœåŠ¡ç”¨çš„æ˜¯ Google çš„ Â <a href="firebase.google.com">Firebase</a>Â  åœ¨å›½å¤–ï¼Œè®¿é—®æˆ–è®¸ä¼šæœ‰ç‚¹æ…¢ã€‚</p>

<h2 id="æ¸²æŸ“é€»è¾‘">æ¸²æŸ“é€»è¾‘</h2>

<p>å¼€å‘ä¸€ä¸ªæ¸¸æˆï¼Œæ¸²æŸ“è‚¯å®šæ˜¯é‡ä¸­ä¹‹é‡ï¼Œå°±å…ˆæ¥è°ˆä¸€è°ˆæ¸²æŸ“é€»è¾‘çš„å®ç°ã€‚é¦–å…ˆå‘¢è¿™æ˜¯ä¸€ä¸ª 2D æ¸¸æˆï¼Œé‚£ä¹ˆæ¸²æŸ“è‡ªç„¶ä¹Ÿåªç”¨è€ƒè™‘ 2D å°±å¥½äº†ï¼Œå½“ç„¶æœ€ä¸»è¦çš„åŸå› è‚¯å®šæ˜¯ç®€å•ã€‚<strong>ä¸‹é¢é€»è¾‘çš„æè¿°å°±éƒ½å†™åœ¨ä»£ç çš„æ³¨é‡Šé‡Œäº†</strong></p>

<h3 id="æ¸²æŸ“å™¨-renderer">æ¸²æŸ“å™¨ Renderer</h3>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// EntityRenderMap æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªä¸ªçš„å®ä½“çš„æ¸²æŸ“æ–¹æ³•ï¼Œå®ä½“æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­å°±æ˜¯è¿™ä¸ªæ¸¸æˆä¸­çš„ä¸€é¢—æ ‘ã€ä¸€ä¸ªå°çƒã€æˆ–è€…æ˜¯ RPG æ¸¸æˆä¸­çš„ä¸€ä¸ªäººç‰©ã€‚</span>
<span class="kr">interface</span> <span class="nx">RendererProps</span> <span class="p">{</span>
  <span class="nl">entityRenderMap</span><span class="p">?:</span> <span class="nx">EntityRenderMap</span><span class="p">;</span>
  <span class="nl">style</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">CSSStyleDeclaration</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">Renderer</span> <span class="p">{</span>
  <span class="nx">dom</span><span class="o">!</span><span class="p">:</span> <span class="nx">HTMLCanvasElement</span><span class="p">;</span>
  <span class="nx">ctx</span><span class="o">!</span><span class="p">:</span> <span class="nx">CanvasRenderingContext2D</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">actualWidth</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Canvas å®é™…å®½åº¦ï¼Œä¸‹æ–‡æœ‰æè¿°</span>
  <span class="nl">actualHeight</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">entityRenderMap</span><span class="p">:</span> <span class="nx">EntityRenderMap</span> <span class="o">=</span> <span class="nx">entityRenderMap</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">?:</span> <span class="nx">RendererProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨å°±æ˜¯åˆ›å»ºä¸€ä¸ª Canvas</span>
    <span class="kd">const</span> <span class="nx">dom</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">canvas</span><span class="dl">"</span><span class="p">);</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">dom</span><span class="p">,</span>
      <span class="na">ctx</span><span class="p">:</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="dl">"</span><span class="s2">2d</span><span class="dl">"</span><span class="p">),</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">entityRenderMap</span><span class="p">,</span> <span class="nx">style</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">entityRenderMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åˆ›å»ºæ¸²æŸ“å™¨æ—¶æŒ‡å®šæ¯ä¸€ä¸ªå®ä½“çš„æ¸²æŸ“æ–¹æ³•ï¼Œå†ä¸é»˜è®¤å†…éƒ¨æä¾›çš„ä¸€äº›å®ä½“æ¸²æŸ“æ–¹æ³•åšåˆå¹¶</span>
        <span class="nx">entityRenderMap</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">render</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">entityRenderMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">render</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">style</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">setStyle</span><span class="p">(</span><span class="nx">style</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">CSSStyleDeclaration</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">style</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">style</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">as</span> <span class="kr">string</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">setVisible</span><span class="p">(</span><span class="nx">visible</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æŒ‡å®šè¯¥æ¸²æŸ“å™¨æ˜¯å¦å¯è§ï¼Œä¸€ä¸ªæ¸¸æˆå¯èƒ½å­˜åœ¨å¤šä¸ªæ¸²æŸ“å™¨ï¼Œå¯ä»¥å°†æ¸¸æˆç•Œé¢å’ŒUIç•Œé¢å…·ä½“çš„æ¸¸æˆç”»é¢åŒºåˆ†å¼€æ¥</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">visible</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="na">visibility</span><span class="p">:</span> <span class="nx">visible</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">visible</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">penetrate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">setPenetrate</span><span class="p">(</span><span class="nx">penetrate</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ç»‘å®šæ¸²æŸ“å™¨ç©¿é€äº‹ä»¶ï¼Œåº”ç”¨åœºæ™¯ï¼šæˆ‘è¿™ä¸ªæ¸¸æˆåœ¨ç©çš„æ—¶å€™åˆ†æ•°å±äºUIæ¸²æŸ“å™¨ï¼Œä½†æ˜¯å¤„äºæ¸¸æˆæ¸²æŸ“å™¨çš„ä¸Šé¢ï¼Œç»‘å®šæ ·å¼ä½¿å…¶å¯ä»¥äº‹ä»¶ç©¿é€åˆ°æ¸¸æˆçš„ç•Œé¢ã€‚</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">penetrate</span> <span class="o">=</span> <span class="nx">penetrate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">({</span> <span class="na">pointerEvents</span><span class="p">:</span> <span class="nx">penetrate</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">auto</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">setSize</span><span class="p">(</span><span class="nx">width</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">height</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">dom</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">px</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">px</span><span class="dl">"</span><span class="p">;</span>

    <span class="cm">/**
     * è®¾ç½®è¿™ä¸ª Canvas çš„æ ·å¼å¤§å°æ²¡å¾—è¯´çš„
     * ä½†æ˜¯è¿™é‡Œæœ‰ä¸ª getActualPixel æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å°è£…çš„ï¼Œå¯ä»¥æ‹¿åˆ°å½“å‰å±å¹•çš„å®é™…åƒç´ 
     * ä¾‹å¦‚æœ‰çš„å±å¹•æ˜¯ 2Kã€4K çš„ï¼Œé‚£ä¹ˆè¦ç”»ä¸€ä¸ª 100px*100px çš„æ­£æ–¹å½¢åœ¨ 2K å±å¹•ä¸Šå°±éœ€è¦ç”»æˆ 200px*200pxã€‚
     * */</span>
    <span class="kd">const</span> <span class="nx">actualWidth</span> <span class="o">=</span> <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">width</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">actualHeight</span> <span class="o">=</span> <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">actualWidth</span><span class="p">;</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">actualHeight</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">width</span><span class="p">,</span>
      <span class="nx">height</span><span class="p">,</span>
      <span class="nx">actualWidth</span><span class="p">,</span>
      <span class="nx">actualHeight</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nl">translateX</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">translateY</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">translate</span><span class="p">(</span><span class="nx">x</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">y</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ç”»å¸ƒåç§»ï¼šåœ¨æˆ‘è¿™ä¸ªæ¸¸æˆä¸­ å°çƒåœ¨ä¸€ç›´çš„å¾€ä¸‹èµ°ï¼Œä½†æ˜¯è¦ä¿è¯å°çƒè¿˜èƒ½åœ¨å±å¹•çš„ä¸­é—´å¯è§åŒºåŸŸï¼Œé‚£ä¹ˆå°±ç»™ç”»å¸ƒåšä¸€ä¸ª Y è½´çš„è´Ÿåç§»ã€‚</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">translateX</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">translateY</span> <span class="o">+=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">y</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">resetTranslate</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// é‡ç½®ç”»å¸ƒåç§»</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">translateX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">translateY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">setTransform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**
   * æ¸²æŸ“é€»è¾‘
   * scene åœºæ™¯ï¼šåœºæ™¯å†…åŒ…å«æ•´ä¸ªç•Œé¢å†…çš„å®ä½“
   * camera ç…§ç›¸æœºï¼šå®šä¹‰çœŸæ­£æ‰€èƒ½çœ‹åˆ°çš„åŒºåŸŸã€‚ä¹‹å‰æœ‰å­¦è¿‡ä¸€æ®µæ—¶é—´çš„ 3DMax å®ƒé‡Œé¢å°±æœ‰ç…§ç›¸æœºçš„æ¦‚å¿µï¼Œå®é™…ç»™ç”¨æˆ·æ‰€çœ‹åˆ°çš„åœºæ™¯å°±æ˜¯ç…§ç›¸æœºæ‰€çœ‹åˆ°çš„èŒƒå›´ã€‚
   * æ¸²æŸ“å™¨ã€ç…§ç›¸æœºã€åœºæ™¯ è¿™ä¸‰ä¸ªæ˜¯è¦é…åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œæ¸²æŸ“å‡ºç…§ç›¸æœºèŒƒå›´å†…çš„åœºæ™¯ï¼ˆä¸€ä¸ªä¸ªçš„å®ä½“ï¼‰ã€‚
   * */</span>
  <span class="nx">render</span><span class="p">(</span><span class="nx">scene</span><span class="p">:</span> <span class="nx">Scene</span><span class="p">,</span> <span class="nx">camera</span><span class="p">:</span> <span class="nx">Camera</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span>
      <span class="nx">ctx</span><span class="p">,</span>
      <span class="nx">entityRenderMap</span><span class="p">,</span>
      <span class="nx">actualWidth</span><span class="p">,</span>
      <span class="nx">actualHeight</span><span class="p">,</span>
      <span class="nx">translateX</span><span class="p">,</span>
      <span class="nx">translateY</span><span class="p">,</span>
    <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="p">{</span>
      <span class="c1">// æ¯æ¬¡ç»˜åˆ¶æ–°çš„ç”»é¢ä¹‹å‰è¦æ¸…é™¤ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„ç”»é¢</span>
      <span class="kd">const</span> <span class="nx">renderX</span> <span class="o">=</span> <span class="nx">getActualPixel</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="nx">translateX</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">renderY</span> <span class="o">=</span> <span class="nx">getActualPixel</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="nx">translateY</span><span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span>
        <span class="nx">renderX</span><span class="p">,</span>
        <span class="nx">renderY</span><span class="p">,</span>
        <span class="nx">renderX</span> <span class="o">+</span> <span class="nx">actualWidth</span><span class="p">,</span>
        <span class="nx">renderY</span> <span class="o">+</span> <span class="nx">actualHeight</span>
      <span class="p">);</span>
    <span class="p">}</span>

    <span class="p">{</span>
      <span class="c1">// ç»˜åˆ¶ç…§ç›¸æœºåŒºåŸŸ å‚è€ƒæ–¹æ³•ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/clip</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">;</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="c1">// è·¯å¾„å¼€å§‹</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">rect</span><span class="p">(</span>
        <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">left</span><span class="p">),</span>
        <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">top</span><span class="p">),</span>
        <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">width</span><span class="p">),</span>
        <span class="nx">getActualPixel</span><span class="p">(</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">clip</span><span class="p">();</span> <span class="c1">// ç”»ä¸€ä¸ªæ­£æ–¹å½¢çš„åŒºåŸŸç”¨æ¥é™åˆ¶ä¹‹åæ‰€æœ‰çš„å…ƒç´ éƒ½åªä¼šåœ¨æ­£æ–¹å½¢èŒƒå›´å†…æ˜¾ç¤º</span>
    <span class="p">}</span>

    <span class="p">{</span>
      <span class="c1">// ç»˜åˆ¶åœºæ™¯ä¸­çš„æ¯ä¸€ä¸ª entity</span>
      <span class="nx">scene</span><span class="p">.</span><span class="nx">entityMap</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">entity</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">.</span><span class="nx">visible</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// å®ä½“ä¸å¯è§ä¸ç»˜åˆ¶</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="c1">// æ¯ä¸€ä¸ªå®ä½“ç»˜åˆ¶å‰å¼€å¯æ–°çš„è·¯å¾„</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// å®ä½“æœ‰è‡ªå¸¦çš„æ¸²æŸ“æ–¹æ³•</span>
          <span class="nx">entity</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="nx">entityRenderMap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="kd">type</span><span class="p">);</span>
          <span class="c1">// è·å–è¯¥å®ä½“ç±»å‹é…ç½®çš„æ¸²æŸ“æ–¹æ³•</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">render</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`The </span><span class="p">${</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2"> Entity requires a render method!`</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œæˆ‘å°† <strong>æ¸²æŸ“å™¨ <code class="language-plaintext highlighter-rouge">Renderer</code></strong> çš„æ¦‚å¿µå®šä¹‰ä¸ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Renderer</code> å°±æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">canvas</code>ï¼Œä¸€ä¸ªæ¸¸æˆå¯èƒ½æœ‰å¤šä¸ª Canvas å…±åŒç»„æˆï¼Œä¸€ä¸ªæ¸²æŸ“å™¨å¯¹åº”äº†ä¸€ä¸ª <strong>ç…§ç›¸æœº <code class="language-plaintext highlighter-rouge">Camera</code></strong> å’Œä¸€ä¸ª <strong>åœºæ™¯ <code class="language-plaintext highlighter-rouge">Scene</code></strong> ï¼Œå½“ç„¶æ¸¸æˆå¼€å‘ä¸­ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Renderer</code> å¯¹åº”å¤šä¸ª <code class="language-plaintext highlighter-rouge">Camera</code> ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„æ“ä½œï¼Œåªä¸è¿‡æˆ‘è¿™é‡Œæƒ³äº†æƒ³æˆ‘çš„æ˜¯ 2D æ¸¸æˆï¼Œä¸å­˜åœ¨ä¸€ä¸ªç”»é¢å¤šä¸ªè§†è§’çœ‹çš„æƒ…å†µï¼Œæ‰€ä»¥å°±å®šä¹‰äº†ä¸€å¯¹ä¸€çš„æ¦‚å¿µï¼›<strong>åœºæ™¯ <code class="language-plaintext highlighter-rouge">Scene</code></strong> æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼Œå°±ç›¸å½“äºæ˜¯å¾ˆå¤šä¸ª <strong>å®ä½“ <code class="language-plaintext highlighter-rouge">Entity</code></strong> çš„åˆé›†ï¼Œå°±ä¾‹å¦‚ç”±å±±ã€æ°´ã€äººã€æ ‘ç»„æˆäº†ä¸€å¹…ç”»ã€‚</p>

<h3 id="ç…§ç›¸æœº-camera">ç…§ç›¸æœº Camera</h3>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">CameraConfig</span> <span class="p">{</span>
  <span class="nl">left</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">Camera</span> <span class="p">{</span>
  <span class="nl">left</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">CameraConfig</span> <span class="o">|</span> <span class="nx">Renderer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span> <span class="k">instanceof</span> <span class="nx">Renderer</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// å¦‚æœä¼ å…¥çš„ä¸º Renderer å®ä¾‹ï¼Œåˆ™ç›¸æœºè‡ªåŠ¨è¿½è¸ª Render åŒºåŸŸ</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">traceRenderer</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">observerRenderer</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// æ›´æ–°ç…§ç›¸æœºçš„é…ç½®</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">CameraConfig</span><span class="p">):</span> <span class="nx">Camera</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nl">observerRenderer</span><span class="p">:</span> <span class="nx">Renderer</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="c1">// è¿½è¸ª Render æ¸²æŸ“çš„ä½ç½®ä¸å¤§å°ï¼Œç”¨äºè‡ªåŠ¨ç»˜åˆ¶å‡ºå…¨å±çš„ç”»é¢</span>
  <span class="nx">traceRenderer</span><span class="p">(</span><span class="nx">renderer</span><span class="p">:</span> <span class="nx">Renderer</span><span class="p">):</span> <span class="nx">Camera</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">translateY</span><span class="p">,</span> <span class="nx">translateX</span><span class="p">,</span> <span class="nx">actualWidth</span><span class="p">,</span> <span class="nx">actualHeight</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">renderer</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">top</span><span class="p">:</span> <span class="o">-</span><span class="nx">translateY</span><span class="p">,</span>
      <span class="na">left</span><span class="p">:</span> <span class="o">-</span><span class="nx">translateX</span><span class="p">,</span>
      <span class="na">width</span><span class="p">:</span> <span class="nx">actualWidth</span><span class="p">,</span>
      <span class="na">height</span><span class="p">:</span> <span class="nx">actualHeight</span><span class="p">,</span>
      <span class="nx">renderer</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1">// ä½¿ç”¨ Object.defineProperty å°ä½å“ªä¸ªçš„æ–¹æ³•ï¼Œç”¨æ¥è¿½è¸ªç›¸æœºä½ç½®ä¸å¤§å°</span>
    <span class="nx">observerSet</span><span class="p">(</span><span class="nx">renderer</span><span class="p">,</span> <span class="dl">"</span><span class="s2">translateY</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="o">-</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">observerSet</span><span class="p">(</span><span class="nx">renderer</span><span class="p">,</span> <span class="dl">"</span><span class="s2">translateX</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="o">-</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">observerSet</span><span class="p">(</span><span class="nx">renderer</span><span class="p">,</span> <span class="dl">"</span><span class="s2">actualWidth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">observerSet</span><span class="p">(</span><span class="nx">renderer</span><span class="p">,</span> <span class="dl">"</span><span class="s2">actualHeight</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// å–æ¶ˆå¯¹ Render çš„è¿½è¸ª</span>
  <span class="nx">clearTraceRenderer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">observerRenderer</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">observerRenderer</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">keys</span><span class="p">:</span> <span class="p">(</span><span class="kr">keyof</span> <span class="nx">Renderer</span><span class="p">)[]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">translateY</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">translateX</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">width</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">height</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">clearObserverSet</span><span class="p">(</span><span class="nx">observerRenderer</span><span class="p">,</span> <span class="nx">key</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åœºæ™¯-scene--å®ä½“-entity">åœºæ™¯ Scene &amp; å®ä½“ Entity</h3>

<p>ä¸Šæ–‡æœ‰æåˆ° <strong>åœºæ™¯ <code class="language-plaintext highlighter-rouge">Scene</code></strong> æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼Œå°±ç›¸å½“äºæ˜¯å¾ˆå¤šä¸ª <strong>å®ä½“ <code class="language-plaintext highlighter-rouge">Entity</code></strong> çš„åˆé›†ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">Entity</code> å…·ä½“æ˜¯ä»€ä¹ˆæ ·å­</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">type</span> <span class="nx">EntityType</span> <span class="o">=</span> <span class="nx">Keys</span><span class="o">&lt;</span><span class="nx">CanvasRenderingContext2D</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">EntityRender</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">Entity</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="p">(</span><span class="na">ctx</span><span class="p">:</span> <span class="nx">CanvasRenderingContext2D</span><span class="p">,</span> <span class="na">entity</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">EntityConfig</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Entity å¯ä»¥è¢«å…¶ä»–ç±»ç»§æ‰¿ä½¿ç”¨å†ç”Ÿæˆå®ä¾‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ Entity.create æ–¹æ³•è¿›è¡Œåˆ›å»ºå®ä¾‹</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Entity</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">EntityConfig</span> <span class="o">=</span> <span class="p">{}</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">config</span><span class="p">:</span> <span class="nx">T</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">as</span> <span class="nx">T</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="na">type</span><span class="p">:</span> <span class="nx">EntityType</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="kd">type</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">-</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getRandomId</span><span class="p">();</span> <span class="c1">// éšæœºç”Ÿæˆä¸€ä¸ªID</span>
    <span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mergeConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// æ›´æ–°å®ä½“çš„ config</span>
  <span class="nx">mergeConfig</span><span class="p">(</span><span class="na">config</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// è®¾ç½®è¯¥å®ä½“æ˜¯å¦å¯è§ï¼Œæ¸²æŸ“çš„æ—¶å€™ä¼šå¿½ç•¥ä¸å¯è§çš„å®ä½“</span>
  <span class="nl">visible</span><span class="p">:</span> <span class="nx">boolean</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">setVisible</span><span class="p">(</span><span class="na">visible</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">visible</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// å®šä¹‰å®ä½“æ¸²æŸ“çš„æ–¹æ³•</span>
  <span class="nx">render</span><span class="p">?(</span><span class="nx">ctx</span><span class="p">:</span> <span class="nx">CanvasRenderingContext2D</span><span class="p">):</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å®ä½“çš„ä½¿ç”¨æ–¹å¼åˆä¸¤ç§ï¼Œè€ƒè™‘åˆ°éƒ¨åˆ†å®ä½“åªå…·å¤‡å±•ç¤ºæ•ˆæœï¼ˆå±æ€§ï¼‰ä¸å…·å¤‡åŠ¨ä½œï¼ˆæ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">new Entity(config)</code> ä¼ å…¥å®ä½“æ¸²æŸ“æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œåç»­ä¹Ÿåªéœ€è¦æ›´æ–°è¿™äº›é…ç½®ä¾¿å¯ã€‚</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºä¸€ä¸ªåˆ†æ•°å®ä½“</span>
<span class="kd">const</span> <span class="nx">scoreEntity</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Entity</span><span class="p">(</span><span class="dl">"</span><span class="s2">score</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">count</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">left</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="na">top</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// æ›´æ–°åˆ†æ•°æ—¶</span>
<span class="nx">scoreEntity</span><span class="p">.</span><span class="nx">mergeConfig</span><span class="p">({</span>
  <span class="na">count</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>å®ä½“çš„ç¬¬äºŒç§ä½¿ç”¨æ–¹æ³•æ˜¯ç»§æ‰¿ <code class="language-plaintext highlighter-rouge">Entity</code> ç±»ï¼Œä½¿å…¶ä¸Šé¢åŒ…å«åŸºç¡€çš„å®ä½“å±æ€§æ–¹æ³•è¿˜å¯ä»¥æ‰©å±•ä¸€äº›é¢å¤–çš„å±æ€§ã€äº‹ä»¶ç­‰ã€‚</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºä¸€ä¸ªé›ªçƒå®ä½“</span>
<span class="kd">class</span> <span class="nx">SnowBall</span> <span class="kd">extends</span> <span class="nx">Entity</span> <span class="p">{</span>
  <span class="nx">config</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// ä¸€äº› config</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="dl">"</span><span class="s2">snowball</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mergeConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">move</span><span class="p">()</span> <span class="p">{}</span> <span class="c1">// ç§»åŠ¨é›ªçƒå®ä½“</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{}</span> <span class="c1">// å®šä¹‰é›ªçƒå®ä½“å¦‚ä½•æ¸²æŸ“</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">snowBall</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SnowBall</span><span class="p">({});</span> <span class="c1">// æ„å»ºé›ªçƒå®ä¾‹</span>
</code></pre></div></div>

<p>æ¥ä¸‹æ¥çœ‹çœ‹ <strong>åœºæ™¯ <code class="language-plaintext highlighter-rouge">Scene</code></strong> å§ï¼Œåœºæ™¯å…¶å®å°±ç¨å¾®å¯¹ <code class="language-plaintext highlighter-rouge">Map</code> å°è£…ä¸€ä¸‹ã€‚</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">EntityMap</span> <span class="o">=</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">Entity</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">Scene</span> <span class="p">{</span>
  <span class="nl">entityMap</span><span class="p">:</span> <span class="nx">EntityMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span> <span class="c1">// åœºæ™¯å†…å®ä½“çš„åˆé›†</span>

  <span class="c1">// ç»™åœºæ™¯å†…æ·»åŠ å®ä½“</span>
  <span class="nx">add</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">Entity</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">entity</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">entityMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">entity</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">entity</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// æ¸…ç©ºåœºæ™¯</span>
  <span class="nx">clear</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">entityMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">remove</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ä»åœºæ™¯å†…åˆ é™¤å®ä½“</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">entityMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="åŠ¨ç”»">åŠ¨ç”»</h2>

<p>ä¸€ä¸ªæ¸¸æˆåŠ¨ç”»ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œåœ¨å‰ç«¯ Canvas é‡Œé¢å…¶å®ä¸å­˜åœ¨åŠ¨ç”»è¿™ä¸ªæ¦‚å¿µï¼Œå®ƒå°±æ˜¯ç»˜åˆ¶ä¸€å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬åªéœ€å°†æ¯æ¬¡ç»˜åˆ¶çš„å›¾ç‰‡é‡Œé¢çš„å…ƒç´ ä½ç½®åšä¸€äº›è°ƒæ•´ï¼Œé‚£ä¹ˆå¿«é€Ÿçš„ç»˜åˆ¶å¤šå¼ å°±ä¼šå½¢æˆä¸€ä¸ªåŠ¨ç”»çš„æ•ˆæœã€‚è¿™ç§åœºæ™¯åœ¨ JS ä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šæƒ³åˆ° <code class="language-plaintext highlighter-rouge">setInterval, setTimeout</code> ç­‰ï¼›å®é™…å†å†™æ¸¸æˆã€åŠ¨ç”»çš„æ—¶å€™éƒ½æ˜¯ç”¨åˆ° <code class="language-plaintext highlighter-rouge">requestAnimationFrame</code> è¿™ä¸ª API çš„ï¼Œè¿™é‡Œæµ…æµ…çš„è®²ä¸€ä¸‹ä»–ä»¬çš„åŒºåˆ«ã€‚</p>

<h3 id="setinterval-ä¸-settimeout">setInterval ä¸ setTimeout</h3>

<p>è¿™ä¸¤ä¸ªçš„æ¦‚å¿µå…¶å®æ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½æ˜¯æµè§ˆå™¨ JS å¼•æ“æä¾›çš„æ–¹æ³•ï¼Œæ— éå°±æ˜¯æ˜¯ç”¨ <code class="language-plaintext highlighter-rouge">setTimeout</code> è¦åšä¸€ä¸ªé€’å½’é€»è¾‘ã€‚JS å¼•æ“æ˜¯å•çº¿ç¨‹çš„ï¼Œåœ¨ä½¿ç”¨è¿™äº›å¼‚æ­¥æ–¹æ³•çš„æ—¶å€™ä¼šå°†å…¶æ·»åŠ è‡³ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œç­‰å¾…ä¸»ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†æ¥æ‰§è¡Œè¿™äº›å¼‚æ­¥ä»»åŠ¡å°±æœ‰å¯èƒ½é€ æˆä¸€ä¸ªå»¶è¿Ÿæ‰§è¡Œï¼Œè¾¾åˆ°çš„æ•ˆæœæ¯”é¢„æœŸçš„è¦æ…¢ï¼Œä¸è¿‡è¿™ä¸ªä¸æ˜¯ä¸»è¦çš„é—®é¢˜ï¼Œä¸»è¦çš„é—®é¢˜æ˜¯æ¸²æŸ“ä¸åŒæ­¥ï¼Œä¾‹å¦‚å½“å‰æ˜¾ç¤ºå™¨åˆ·æ–°ç‡æ˜¯æ¯éš” 100 æ¯«ç§’åˆ·æ–°ä¸€ä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">setInterval</code> è®¾ç½®çš„æ˜¯ 50 æ¯«ç§’ç»˜åˆ¶ä¸€ä¸‹ï¼Œè¿™ä¸¤ä¸ªä¸åŒæ­¥å°±ä¼šå¯¼è‡´æœ‰çš„æ—¶å€™ JS ç»˜åˆ¶äº†æœ€æ–°çš„æ•ˆæœï¼Œä½†æ˜¯æ˜¾ç¤ºå™¨è¿˜æ²¡åˆ·æ–°ã€‚ç„¶åå†æ˜¾ç¤ºå™¨ä¸‹æ¬¡åˆ·æ–°æ—¶å€™ï¼Œå·²ç»ç´¯åŠ äº†å‡ æ¬¡çš„ JS ç»˜åˆ¶å°±ä¼šå‡ºç°è·³å¸§ï¼Œå¡é¡¿ç°è±¡ã€‚</p>

<h3 id="requestanimationframe">requestAnimationFrame</h3>

<p><code class="language-plaintext highlighter-rouge">requestAnimationFrame</code> ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œè€Œä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´æ˜¯è·Ÿç€æ˜¾ç¤ºå™¨çš„åˆ·æ–°ç‡æ¥çš„ï¼Œè¿™æ ·æ— è®ºåœ¨é«˜åˆ·è¿˜æ˜¯ä½åˆ·çš„å±å¹•ä¸Šéƒ½èƒ½æœ‰å¾ˆå¥½çš„ä½“éªŒã€‚</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Callback</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">timestamp</span><span class="p">:</span> <span class="kr">number</span><span class="p">):</span> <span class="nx">boolean</span> <span class="o">|</span> <span class="nx">unknown</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">AnimationEvent</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">animation</span><span class="p">:</span> <span class="nx">Animation</span><span class="p">):</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">AnimationEvents</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">[</span><span class="nx">AnimationEvent</span><span class="p">,</span> <span class="kr">number</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">Animation</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">callback</span><span class="p">:</span> <span class="nx">Callback</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nl">timer</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">animation</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">stationary</span><span class="dl">"</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">stationary</span><span class="dl">"</span><span class="p">;</span>
  <span class="nl">startTime</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">prevTime</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">start</span><span class="p">(</span><span class="nx">timeout</span><span class="p">?:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">animation</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">animation</span> <span class="o">=</span> <span class="p">(</span><span class="nx">timestamp</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="p">{</span> <span class="nx">startTime</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">startTime</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">startTime</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="nx">startTime</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">timeout</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nx">timestamp</span> <span class="o">-</span> <span class="nx">startTime</span> <span class="o">&gt;</span> <span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span> <span class="c1">// å¦‚æœä¼ å…¥äº†è¶…æ—¶æ—¶é—´ åˆ™åŠ¨ç”»å°±ä¼šå†æ‰§è¡Œä¸€æ®µæ—¶é—´ååœæ­¢</span>
      <span class="p">}</span>

      <span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">evnets</span><span class="p">,</span> <span class="nx">prevTime</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">millisecond</span> <span class="o">=</span> <span class="nx">timestamp</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">prevMillisecond</span> <span class="o">=</span> <span class="nx">prevTime</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">;</span>

        <span class="c1">// evnets ç»´æŠ¤äº†ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ— å¯ä»¥è®¾ç½®æ¯éš”å¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡äº‹ä»¶</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">[</span><span class="nx">event</span><span class="p">,</span> <span class="nx">stepMillisecond</span><span class="p">]</span> <span class="k">of</span> <span class="nx">evnets</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">step</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">millisecond</span> <span class="o">/</span> <span class="nx">stepMillisecond</span><span class="p">);</span>
          <span class="kd">const</span> <span class="nx">prevStep</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">prevMillisecond</span> <span class="o">/</span> <span class="nx">stepMillisecond</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">!==</span> <span class="nx">prevStep</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">event</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">keep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">);</span> <span class="c1">// å¦‚æœå›è°ƒå‡½æ•°è¿”å›äº† false åˆ™è¡¨ç¤ºè¦åœæ­¢åŠ¨ç”»</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">keep</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prevTime</span> <span class="o">=</span> <span class="nx">timestamp</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">animation</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">animation</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">stationary</span><span class="dl">"</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nl">evnets</span><span class="p">:</span> <span class="nx">AnimationEvents</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="cm">/**
   * @description å¢åŠ äº‹ä»¶ï¼Œè®©åŠ¨ç”»æ‰§è¡Œæ—¶æ¯éš”å¤šå°‘æ¯«ç§’æ‰§è¡Œä¸€æ¬¡äº‹ä»¶
   * @param event äº‹ä»¶
   * @param millisecond æ¯«ç§’
   */</span>
  <span class="nx">bind</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">AnimationEvent</span><span class="p">,</span> <span class="nx">millisecond</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">evnets</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">event</span><span class="p">,</span> <span class="nx">millisecond</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// ç§»é™¤äº‹ä»¶</span>
  <span class="nx">remove</span><span class="p">(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">AnimationEvent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">evnets</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">event</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">evnets</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="äº‹ä»¶">äº‹ä»¶</h2>

<p>è¿™é‡Œè¿˜å°è£…äº†ä¸€ä¸ªäº‹ä»¶ï¼Œä¸»è¦æ˜¯é’ˆå¯¹ç§»åŠ¨ç«¯å’Œ PC ç«¯çš„èåˆï¼Œç°é˜¶æ®µæ”¯æŒäº†ä¸‰ä¸ªäº‹ä»¶ï¼Œåˆ†åˆ«æ˜¯é¼ æ ‡æŒ‰ä¸‹ã€é¼ æ ‡æŠ¬èµ·ã€å’Œç‚¹å‡»ï¼Œå¯¹åº”åˆ°æ‰‹æœºå°±æ˜¯æ‰‹æŒ‡çš„æ“ä½œï¼Œåç»­è¿˜å¯ä»¥å°† <code class="language-plaintext highlighter-rouge">mousemove</code> å’Œ <code class="language-plaintext highlighter-rouge">touchmove</code> ä¹Ÿåšä¸€ä¸ªåˆå¹¶ã€‚<strong>ï¼ˆ 2022.2.8 æ›´æ–° <code class="language-plaintext highlighter-rouge">move</code> äº‹ä»¶ä¹ŸåŠ ä¸Šäº† ï¼‰</strong></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">TMEventType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">touchStart</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">touchMove</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">touchEnd</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">TMEventType</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
  <span class="nl">pointX</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">pointY</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">originEvent</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">TMEventType</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="p">(</span><span class="na">e</span><span class="p">:</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">):</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IEventListener</span> <span class="p">{</span>
  <span class="nl">touchStart</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">touchStart</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">[];</span>
  <span class="nl">touchMove</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">touchMove</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">[];</span>
  <span class="nl">touchEnd</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">touchEnd</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">[];</span>
  <span class="nl">tap</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">[];</span>
<span class="p">}</span>

<span class="cm">/**
 * Touch Mouse Event
 * åˆå¹¶äº† PC åŠç§»åŠ¨ç«¯çš„äº‹ä»¶ï¼Œå®ç°äº†ç±»ä¼¼äº click çš„ tap äº‹ä»¶ã€‚
 */</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TMEvent</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">dom</span><span class="p">:</span> <span class="nx">HTMLCanvasElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchstart</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchTouchEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchStart</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchmove</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchTouchEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchMove</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchend</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchTouchEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchEnd</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">mousedown</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchMouseEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchStart</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">mousemove</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchMouseEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchMove</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">mouseup</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchMouseEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">touchEnd</span><span class="dl">"</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">dispatchMouseEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">:</span> <span class="nx">TMEventType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">e</span><span class="p">:</span> <span class="nx">MouseEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">rect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

      <span class="kd">const</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="kd">type</span><span class="p">]</span> <span class="k">as</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span><span class="p">[];</span>
      <span class="kd">const</span> <span class="na">eventOption</span><span class="p">:</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kd">type</span><span class="p">,</span>
        <span class="na">pointX</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
        <span class="na">pointY</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span>
        <span class="na">originEvent</span><span class="p">:</span> <span class="nx">e</span><span class="p">,</span>
      <span class="p">};</span>
      <span class="nx">listeners</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">(</span><span class="nx">eventOption</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">bindTapEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">,</span> <span class="nx">eventOption</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">dispatchTouchEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">:</span> <span class="nx">TMEventType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">e</span><span class="p">:</span> <span class="nx">TouchEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

      <span class="kd">const</span> <span class="nx">firstTouch</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">firstTouch</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">const</span> <span class="nx">rect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

      <span class="kd">const</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="kd">type</span><span class="p">]</span> <span class="k">as</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span><span class="p">[];</span>
      <span class="kd">const</span> <span class="na">eventOption</span><span class="p">:</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kd">type</span><span class="p">,</span>
        <span class="na">pointX</span><span class="p">:</span> <span class="nx">firstTouch</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
        <span class="na">pointY</span><span class="p">:</span> <span class="nx">firstTouch</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span>
        <span class="na">originEvent</span><span class="p">:</span> <span class="nx">e</span><span class="p">,</span>
      <span class="p">};</span>
      <span class="nx">listeners</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">(</span><span class="nx">eventOption</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">bindTapEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">,</span> <span class="nx">eventOption</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nl">tapStartTime</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">bindTapEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">:</span> <span class="nx">TMEventType</span><span class="p">,</span> <span class="nx">eventOption</span><span class="p">:</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tapStartTime</span> <span class="o">&amp;&amp;</span> <span class="nx">currentTime</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">tapStartTime</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 500 æ¯«ç§’å†… è¡¨ç¤ºç‚¹å‡»äº‹ä»¶</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dispatchTapEvent</span><span class="p">(</span><span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">eventOption</span><span class="p">,</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tapStartTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="kd">type</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">touchStart</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tapStartTime</span> <span class="o">=</span> <span class="nx">currentTime</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">dispatchTapEvent</span><span class="p">(</span><span class="kd">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="p">,</span> <span class="nx">eventOption</span><span class="p">:</span> <span class="nx">TMJoinEventOption</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="kd">type</span><span class="p">]</span> <span class="k">as</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">tap</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">[];</span>
    <span class="nx">listeners</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">event</span><span class="p">(</span><span class="nx">eventOption</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nl">_listeners</span><span class="p">:</span> <span class="nx">IEventListener</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">touchStart</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">touchMove</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">touchEnd</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">tap</span><span class="p">:</span> <span class="p">[],</span>
  <span class="p">};</span>

  <span class="nx">add</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">TMEventType</span><span class="p">,</span> <span class="nx">event</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">remove</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span> <span class="nx">TMEventType</span><span class="p">,</span> <span class="nx">event</span><span class="p">:</span> <span class="nx">TMJoinEvent</span><span class="o">&lt;</span><span class="nx">TMEventType</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">findIndex</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">item</span> <span class="o">===</span> <span class="nx">event</span>
    <span class="p">);</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">][</span><span class="nx">index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç»“è¯­">ç»“è¯­</h2>

<blockquote>
  <p>è¿™ä¸ªâ€œå¼•æ“â€å‘¢å…¶å®å°±æ˜¯ä¸€äº›ç®€å•çš„å°è£…ï¼Œ<strong>æ¸²æŸ“å™¨ Renderer</strong> æ˜¯å°† Canvas å¯¹è±¡è¿›è¡Œå°è£…ï¼Œå¹¶æä¾›äº†ä¸€äº›æ›´ä¾¿æ·çš„æ–¹æ³•ï¼Œå…·ä½“æ€ä¹ˆæ¸²æŸ“å…ƒç´ è¿™äº›ä¹Ÿæ²¡åšå¤„ç†ï¼›<strong>ç…§ç›¸æœº Camera</strong> å…¶å®å°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ¦‚å¿µï¼Œæè¿°äº†ä¸€ä¸ªæ­£æ–¹å½¢çš„å¤§å°å®½é«˜ï¼Œç„¶åè®©æ¸²æŸ“çš„æ—¶å€™åªæ¸²æŸ“è¿™ä¸ªæ­£æ–¹å½¢å†…çš„å†…å®¹ï¼›<strong>å®ä½“ Entity</strong> æ˜¯å°†æ¸¸æˆé‡Œé¢å­˜ç€çš„å…ƒç´ ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥è§„èŒƒäº†ä¸€éã€‚<strong>åœºæ™¯ Â Scene</strong> å°±æ˜¯ä¸€äº› <strong>å®ä½“ Entity</strong> çš„é›†åˆã€‚</p>
</blockquote>

<p>è¿™ç¯‡ä¸»è¦å°†çš„æ˜¯â€œå¼•æ“â€çš„å®ç°ï¼Œæ²¡æœ‰ä»€ä¹ˆå®é™…çš„åº”ç”¨ï¼Œåç»­è¿˜ä¼šå†å‘ä¸€ç¯‡å¦‚ä½•ä½¿ç”¨è¯¥â€œå¼•æ“â€æ¥å¼€å‘ä¸€ä¸ª Canvas å°æ¸¸æˆã€‚
å…³äºâ€œå¼•æ“â€çš„è®¾è®¡åŸºæœ¬éƒ½æ˜¯æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•æ¥å®ç°çš„ï¼Œæˆ–è®¸æœ‰äº›åœ°æ–¹ä¸è¶³ï¼Œæˆ–è€…è®¾è®¡ä¸åˆç†ï¼Œä¹Ÿæ¬¢è¿åœ¨è¯„è®ºé‡Œé¢æä¸€äº›å»ºè®®~ã€‚æœ¬ç¯‡ä¸­ Canvas çš„å†…å®¹å¹¶ä¸å¤šï¼Œæ›´å¤šå¯¹äº Canvas ä¸Šçš„ä½¿ç”¨å°†ä¼šå†ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†çš„æè¿°ã€‚</p>

<p>é¡¹ç›®ä»“åº“åœ¨è¿™é‡Œ <a href="https://github.com/h5-games/ball">Github</a> é‡Œé¢æœ‰æ•´ä¸ªæ¸¸æˆå’Œå¼•æ“çš„å®Œæ•´ä»£ç ï¼Œæƒ³è¦äº†è§£ Canvas çš„å¯ä»¥çœ‹ä¸€çœ‹ã€‚</p>

<p>ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šå°½å¿«çš„ï¼Œçœ‹èƒ½ä¸èƒ½èµ¶åœ¨å¹´å‰ï¼ˆå†œå†ï¼‰æå®šï¼Œè¦æ˜¯æä¸å®šä»¥ç°åœ¨è¥¿å®‰çš„ç–«æƒ…æ¥çœ‹ï¼Œä»Šå¹´è¿‡å¹´åæœ‰å…«ä¹æ˜¯å›ä¸å»äº†ï¼Œè¦æ˜¯æ²¡å†™å®Œåˆ°æ—¶å€™å¯èƒ½è¿‡å¹´å°±å¾…åœ¨ä¸Šæµ·å†™æ–‡ç« äº†ã€‚</p>

<p>2021 å¹´ 12 æœˆ 31 æ—¥ 23:00 è¿˜æœ‰ä¸€ä¸ªå°æ—¶å°± 2022 å¹´äº†ï¼Œæå‰ç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼</p>

<p><strong>ä»Šå¹´ç»ˆäºä¸æ˜¯ 0 äº§å‡º å˜¿å˜¿~</strong></p>

      <div class="date">å‘å¸ƒæ—¶é—´ï¼š2021-12-31</div>
    </div>
    <div class="nav-container">
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4613132254509352"
        crossorigin="anonymous"></script>
      <!-- post-article -->
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4613132254509352" data-ad-slot="8065948199"
        data-ad-format="auto" data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      <div class="main-nav">
        <div class="title">ç›®å½•</div>
      </div>
    </div>
  </div>
  <footer id="footer">
  <a title="Github" href="https://github.com/jaceyi">
    <i class="iconfont">&#xe600;</i>
  </a>
  <a title="æ˜é‡‘" href="https://juejin.im/user/5a3b2016f265da43231b22a7">
    <i class="iconfont">&#xe610;</i>
  </a>
  <a title="ä¸ªäººç½‘ç«™" href="https://jaceyi.com/">
    <i class="iconfont">&#xe789;</i>
  </a>
  <a title="Twitter" href="https://twitter.com/jaceyi123">
    <i class="iconfont">&#xe602;</i>
  </a>
</footer>

  <div class="back-top">
  <i class="iconfont">&#xe6d9;</i>
</div>
<script>
  (function (d, w) {
    function scrollTo(targetY) {
      var currentY =
        d.documentElement.scrollTop || d.body.scrollTop;
      var distance = (currentY - targetY) / 10;

      function animate() {
        var currentY =
          d.documentElement.scrollTop || d.body.scrollTop;
        var top = currentY - distance;
        top = top < 0 ? 0 : top;
        w.scrollTo(0, top);
        if (top === 0) return;
        w.requestAnimationFrame(animate);
      }

      animate();
    }
    var $upTop = d.querySelector('.back-top');

    $upTop.onclick = function () {
      scrollTo(0);
    };

    function bindEvent() {
      var scrollTop = d.documentElement.scrollTop || d.body.scrollTop;
      if (scrollTop > 100) {
        $upTop.style.display = 'block';
      } else {
        $upTop.style.display = 'none';
      }
    }

    w.addEventListener('scroll', bindEvent);
    w.addEventListener('load', bindEvent);
  })(document, window);
</script>

  <script src="/js/prism.js"></script>
  <script>
    (function (w, d) {
      var $nav = document.querySelector('.main-nav');
      var $article = document.querySelector('.article');
      var titleNodeNames = ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'];
      var contentItems = [];
      var navItems = [];
      for (var i = 0; i < $article.children.length; i++) {
        var element = $article.children[i];
        if (titleNodeNames.includes(element.nodeName)) {
          var link = document.createElement('a');
          link.href = '#' + element.innerText;
          link.innerText = element.innerText;
          link.setAttribute('data-head', element.nodeName)

          $nav.appendChild(link);
          navItems.push(link);
          element.id = element.innerText;
          contentItems.push(element);
        }
      }

      function bindEvent() {
        var scrollTop = d.documentElement.scrollTop || d.body.scrollTop;
        for (var i = 0; i < navItems.length; i++) {
          removeClass(navItems[i], 'active');
        }
        for (var i = contentItems.length - 1; i >= 0; i--) {
          if (scrollTop >= getElementTop(contentItems[i])) {
            addClass(navItems[i], 'active');
            return;
          }
        }
        addClass(navItems[0], 'active');
      }
      w.addEventListener('scroll', bindEvent);
      w.addEventListener('load', bindEvent);
    })(window, document)
  </script>
</body>

</html>
