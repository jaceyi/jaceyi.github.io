I"K€<h2 id="å‰è¨€">å‰è¨€</h2>

<!--more-->

<blockquote>
  <p>é˜…è¯»æœ¬ç¯‡æ–‡ç« éœ€æŒæ¡ React Hooks åŸºæœ¬ç”¨æ³•ã€æˆ‘çš„è¿™ç¯‡æ–‡ç« å†…æœ‰å¤§è‡´ä»‹ç» <a href="https://juejin.im/post/6844904093824073742">åœ¨ React é¡¹ç›®ä¸­å…¨é‡ä½¿ç”¨ Hooks</a> æ¬¢è¿é˜…è¯»ã€‚</p>
</blockquote>

<p>è‡ªå®šä¹‰ Hooks å…¶å®å°±æ˜¯åœ¨ç°æœ‰ React æä¾›çš„ Hooks ä¸Šåšä¸€å±‚å°è£…ï¼Œå®ç°ä¸€äº›æ›´æœ‰é’ˆå¯¹æ€§çš„é€»è¾‘ï¼Œæˆ–è€…å¯ä»¥å°†ä¸€äº›æ¯”è¾ƒé€šç”¨çš„ä¸šåŠ¡é€»è¾‘åšä¸€ä¸ªå°è£…ã€‚</p>

<h2 id="class-ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ">Class ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ</h2>

<p>ä¸‹é¢å°†åˆ—ä¸¾ä¸€äº›æˆ‘ä»¬åœ¨ Class ç»„ä»¶å†…å¸¸ç”¨çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä½•ç”¨ Hooks æ¥å®ç°ã€‚</p>

<h3 id="componentdidmount">componentDidMount</h3>

<p>æˆ‘ä»¬éƒ½çŸ¥é“ <code class="language-plaintext highlighter-rouge">useEffect</code> çš„ç¬¬äºŒä¸ªå‚æ•°å¦‚æœä¼ ä¸€ä¸ªç©ºæ•°ç»„ï¼Œé‚£ä¹ˆ useEffect çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå‡½æ•°ï¼‰å°†åªä¼šæ‰§è¡Œä¸€éï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å€Ÿæ­¤å®ç°ä¸€ä¸ªç±»ä¼¼äº componentDidMount çš„ Hooks</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">useDidMount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">useEffect</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="p">[]);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>ä¸Šè¿°å°±å±äºä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰ Hooksï¼Œåªéœ€è¦åœ¨éœ€è¦ç”¨çš„ç»„ä»¶å°†å…¶ <code class="language-plaintext highlighter-rouge">import</code> è¿›å»ä½¿ç”¨å³å¯ã€‚</p>

<h3 id="componentdidupdate">componentDidUpdate</h3>

<p>åœ¨ä¸€äº›æƒ…å†µæˆ‘ä»¬åªéœ€è¦ç›‘å¬ç»„ä»¶çš„æ›´æ–°æƒ…å†µï¼Œè€Œä¸å…³å¿ƒæœ€åˆçš„ä¸€æ¬¡ Mountï¼Œè€Œ <code class="language-plaintext highlighter-rouge">useEffect</code> åœ¨ä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°æ—¶æ˜¯æ— è®ºç»„ä»¶åˆæ¬¡æ¸²æŸ“æˆ–è€…æ›´æ–°éƒ½ä¼šæ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ä½¿ç”¨ä¸€ä¸ªå€¼æ¥ç»´æŠ¤æ˜¯å¦åˆå§‹çŠ¶æ€ï¼Œè¿›è¡Œåˆ¤æ–­å“ªä»è€Œå®ç° Update çš„æ•ˆæœã€‚</p>

<p>è¿™ä¸ªå€¼é¦–è¦çš„åŠŸèƒ½å°±æ˜¯èƒ½åœ¨ç»„ä»¶çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½èƒ½æ‹¿åˆ°ï¼Œè¿™é‡Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">useState</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">useRef</code> æ¥ç»´æŠ¤è¿™æ ·ä¸€ä¸ªåˆå§‹çŠ¶æ€ã€‚å†è€ƒè™‘åˆ° useState çš„å€¼å‘ç”Ÿå˜æ›´ï¼Œåªèƒ½åœ¨ç»„ä»¶ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶æ‰€æ‹¿åˆ°æœ€æ–°çš„ï¼Œè€Œä¸”æˆ‘ä»¬è¿™ä¸ªåˆå§‹çŠ¶æ€çš„å˜æ›´å…¶å®æ˜¯ä¸å½±å“ç»„ä»¶çš„æ›´æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">useRef</code> æ¥ç»´æŠ¤è¿™æ ·ä¸€ä¸ªçŠ¶æ€ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">useDidUpdate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">inputs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">initial</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">initial</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">initial</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">?.();</span>
  <span class="p">},</span> <span class="nx">inputs</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>ä¸Šè¿°ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">useRef</code> æ¥ç»´æŠ¤äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">initial</code> å˜é‡ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºåˆå§‹æ¸²æŸ“ï¼Œè¿˜æ•ˆä»¿ <code class="language-plaintext highlighter-rouge">useEffect</code> æ”¯æŒäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">inputs</code> å‚æ•°ï¼Œä»¥ä¾¿å®ç°ï¼Œé’ˆå¯¹é‚£äº›å€¼æ¥æ›´æ–°æ•ˆæœï¼Œå¦‚æœä¸ä¼  <code class="language-plaintext highlighter-rouge">inputs</code> å‚æ•°é‚£ä¹ˆæ— è®ºæ˜¯ Props æˆ–è€… State çš„æ›´æ–°å¯¼è‡´äº†ç»„ä»¶çš„é‡æ–°æ¸²æŸ“éƒ½ä¼šæ‰§è¡Œåˆ° <code class="language-plaintext highlighter-rouge">callback</code> æ–¹æ³•ã€‚</p>

<blockquote>
  <p>æœ‰å…³å®ç° Class ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå°±è®²åˆ°è¿™é‡Œï¼Œå‰©ä¸‹åŸºæœ¬éƒ½å·®ä¸å¤šã€‚ä¸‹é¢å†åˆ—ä¸¾ä¸€äº›ç®€å•çš„å° ğŸŒ°ï¼Œçœ‹çœ‹è¿˜æœ‰é‚£äº›åœºæ™¯èƒ½ç”¨åˆ°è‡ªå®šä¹‰ Hooksã€‚</p>
</blockquote>

<h2 id="è‡ªå®šä¹‰-hooks-çš„å…¶ä»–åº”ç”¨åœºæ™¯">è‡ªå®šä¹‰ Hooks çš„å…¶ä»–åº”ç”¨åœºæ™¯</h2>

<h3 id="-usevalues">ğŸŒ° useValues</h3>

<p>å…ˆä¸Šä¸ªåœ¨çº¿çš„ Demo é“¾æ¥æ–¹ä¾¿çœ‹ï¼š<a href="https://codesandbox.io/s/react-hooks-iu15t?file=/src/Components/UseState.jsx">CodeSandbox</a></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jace</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">intro</span><span class="p">:</span> <span class="dl">"</span><span class="s2">emmm</span><span class="dl">"</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// åªæ›´æ–° name å­—æ®µ</span>
<span class="nx">setState</span><span class="p">({</span>
  <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jack</span><span class="dl">"</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å†ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">useState</code> æ—¶ç»å¸¸ä¼šæœ‰åªéœ€è¦æ›´æ–° <code class="language-plaintext highlighter-rouge">state</code> å¯¹è±¡å†…æŸä¸€ä¸ªå±æ€§æ—¶ï¼Œè¿˜éœ€è¦å°†å…¶ä»–ä¸æ›´æ”¹çš„æ•°æ®åœ¨ä¼ å…¥è¿›å»ï¼Œè¿™æ ·åœ¨ä½¿ç”¨é‡å¾ˆå¤šçš„æ—¶å€™å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä»£ç ä¹Ÿä¸å¥½çœ‹ã€‚æˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€æ¬¡æ€§æ›´æ–°ä¸€ä¸ªæˆ–è€…å¤šä¸ªå±æ€§ï¼Œå…¶ä»–å±æ€§ä¾æ—§ä¿æŒä¸å˜ï¼Œé‚£å¯ä»¥æŒ‰ç…§è¿™ä¸ªéœ€æ±‚æ¥å°è£…ä¸€ä¸ª Hooksã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">useValues</span> <span class="o">=</span> <span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">values</span><span class="p">,</span> <span class="nx">setValues</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">updateValues</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">_values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">_values</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">values required type is object!</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">setValues</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">_values</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="nx">values</span><span class="p">]</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="p">[</span><span class="nx">values</span><span class="p">,</span> <span class="nx">updateValues</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div>

<p>ä¸Šè¿°å®ç°äº†ä¸€ä¸ªè·Ÿ <code class="language-plaintext highlighter-rouge">useState</code> å¾ˆç±»ä¼¼çš„ Hooksï¼ŒåŒºåˆ«æ˜¯ï¼Œè¿”å›çš„æ›´æ–°å€¼çš„æ–¹æ³•ä¼šåœ¨ä¸Šä¸€æ¬¡çš„å€¼çš„åŸºç¡€ä¸Šæ›´æ–°ï¼Œè¿™é‡Œæœ‰ä½¿ç”¨ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">useCallback</code> æ–¹æ³•å¯¹æˆ‘ä»¬çš„æ›´æ–°å‡½æ•°åšäº†ä¸€ä¸ªç¼“å­˜ï¼Œä¸å¤ªäº†è§£ <code class="language-plaintext highlighter-rouge">useCallback</code> çš„å…·ä½“åº”ç”¨åœºæ™¯å¯ä»¥çœ‹çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://juejin.im/post/6844904101445124110">è¯¦è§£ useCallback &amp; useMemo</a>ã€‚</p>

<p>æ¥ä¸‹æ¥å†æœ‰ä¸Šè¿°éœ€æ±‚çš„æ—¶å€™å°±å¯ä»¥æŠŠ <code class="language-plaintext highlighter-rouge">useValues</code> æ–¹æ³•å¼•å…¥åˆ°ç»„ä»¶å†…ä½¿ç”¨ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useValues</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jace</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">intro</span><span class="p">:</span> <span class="dl">"</span><span class="s2">emmm</span><span class="dl">"</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// åªæ›´æ–° name å­—æ®µ</span>
<span class="nx">setState</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jack</span><span class="dl">"</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>æˆ–è®¸è¿˜æœ‰äº›æƒ…å†µæˆ‘ä»¬éœ€è¦æ›´æ–° <code class="language-plaintext highlighter-rouge">state</code> çš„æ‰€æœ‰çš„å±æ€§ï¼Œè€Œä¸æ˜¯æŸä¸ªåˆ«ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å†å¢åŠ ä¸€ä¸ªè¿”å›çš„æ–¹æ³•ï¼Œç”¨æ¥è¦†ç›– <code class="language-plaintext highlighter-rouge">state</code>ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">useValues</span> <span class="o">=</span> <span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">values</span><span class="p">,</span> <span class="nx">setValues</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">updateValues</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">_values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">_values</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">values required type is object!</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">setValues</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">_values</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="nx">values</span><span class="p">]</span>
  <span class="p">);</span>

  <span class="cm">/**
   * è¿™é‡Œ useCallback æ‰€ä¾èµ–çš„å¤–éƒ¨å˜é‡ setValues ä¸ä¼šå˜ï¼›
   * initialValue æˆ‘ä»¬ä¸éœ€è¦ä»–ä¼šå˜ï¼Œåªç”¨æœ€åˆçŠ¶æ€å°±å¯ä»¥ï¼Œæ‰€ä»¥ useCallback ä¸éœ€è¦ä¼ å…¥ä¾èµ–é¡¹ã€‚
   */</span>
  <span class="kd">const</span> <span class="nx">forceValues</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">((</span><span class="nx">_values</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setValues</span><span class="p">(</span><span class="nx">_values</span> <span class="o">||</span> <span class="nx">initialValue</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">[</span><span class="nx">values</span><span class="p">,</span> <span class="nx">updateValues</span><span class="p">,</span> <span class="nx">forceValues</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¢åŠ äº† <code class="language-plaintext highlighter-rouge">forceValues</code> æ–¹æ³•ä½œä¸ºè¿”å›æ•°ç»„çš„ç¬¬ä¸‰é¡¹ï¼Œç”¨æ¥æ›´æ–°æ•´ä¸ª <code class="language-plaintext highlighter-rouge">values</code>ã€‚æœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦å°† <code class="language-plaintext highlighter-rouge">values</code> é‡ç½®ä¸ºåˆå§‹åŒ–çš„å€¼ï¼Œè¿™é‡Œä¹Ÿå¢åŠ äº†ä¸€ä¸ªé€»è¾‘ï¼Œå¦‚æœ <code class="language-plaintext highlighter-rouge">forceValues</code> æ²¡ä¼ å‚æ•°åˆ™ä¼šåˆå§‹åŒ–ï¼Œä¼ äº†å‚æ•°åˆ™ä¼šè¦†ç›–æ•´ä¸ª <code class="language-plaintext highlighter-rouge">values</code>ã€‚</p>

<h3 id="-usecanceltimer">ğŸŒ° useCancelTimer</h3>

<p>åœ¨å†™ React é¡¹ç›®ä¸­åº”è¯¥æœ‰ä¸å°‘åŒå­¦ä¼šç¢°åˆ°è¿™ç§è­¦å‘Šï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Warning</span><span class="p">:</span>
<span class="nx">Can</span><span class="dl">'</span><span class="s1">t perform a React state update on an unmounted component. This is a no-op,
but it indicates a memory leak in your application. To fix,
cancel all subscriptions and asynchronous tasks in a useEffect cleanup function.
</span></code></pre></div></div>

<p>ä»æŠ¥é”™ä¸­å°±å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™æ˜¯å› ä¸ºç»„ä»¶å·²ç»è¢«å¸è½½ï¼Œä½†æ˜¯ç»„ä»¶çš„å¼‚æ­¥ä»»åŠ¡è¿˜æ²¡å–æ¶ˆï¼Œç­‰åˆ°å¼‚æ­¥ä»»åŠ¡å®Œæˆå†è°ƒç”¨ç»„ä»¶çš„æ–¹æ³•ï¼Œå°±ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè­¦å‘Šã€‚å¦‚æœæˆ‘ä»¬æ˜¯å°†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ç»„ä»¶å¤–é¢å‘¢ï¼Œè·å–æ•°æ®ä¹Ÿæ˜¯é€šè¿‡ç»„ä»¶å¤–é¢çš„æ–¹æ³•è¿›è¡Œè·å–ã€å­˜å‚¨çš„è¯é‚£åº”è¯¥æ˜¯é‡ä¸åˆ°è¿™ç§é—®é¢˜ï¼ˆredux/saga/dvaï¼‰ã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬è®²ä¸€ä¸‹åœ¨ç»„ä»¶å†…é‡åˆ°è¿™ç§é—®é¢˜æ”¹å¦‚ä½•è§£å†³ï¼Œå¯ä»¥æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªå¾ˆé€šç”¨çš„æ“ä½œï¼Œæ¯ä¸€ä¸ªç»„ä»¶å†…éƒ½æœ‰å¯èƒ½ä¼šè¿›è¡Œä¸€äº›å¼‚æ­¥ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡åœ¨ç»“æŸæ˜¯éƒ½æœ‰å¯èƒ½é¢ä¸´è¿™ä¸ªé—®é¢˜ã€‚å¯ä»¥çœ‹çœ‹è¿™ä¸ªåœ¨çº¿ Demo <a href="https://codesandbox.io/s/react-hooks-iu15t?file=/src/Components/UseCancelTimer.jsx">useCancelTimer</a>ã€‚</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Content</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">onClose</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">();</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">setName</span><span class="p">(</span><span class="dl">"</span><span class="s2">jace</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClose</span><span class="si">}</span><span class="p">&gt;</span>Close<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>name: <span class="si">{</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">UseCancelTimer</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">visible</span><span class="p">,</span> <span class="nx">setVisible</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>Show<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="p">&lt;</span><span class="nc">Content</span> <span class="na">onClose</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">Content</code> ç»„ä»¶æŒ‚è½½æ—¶å°±ä¼šå»è¯·æ±‚ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡ä¼šè·å–ä¸€ä¸ªæ•°æ®å¹¶è¿›è¡Œ <code class="language-plaintext highlighter-rouge">setState</code> ï¼Œå¦‚æœæˆ‘ä»¬å†å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸä¹‹å‰ç‚¹å‡» Close æŒ‰é’®ï¼Œå¯¼è‡´ç»„ä»¶è¢«å¸è½½ï¼Œé‚£ä¹ˆåœ¨ Console ä¸­å°±ä¼šæŠ›ä¸Šè¿°é”™è¯¯ã€‚</p>

<p>æˆ‘ä»¬è¦æƒ³ä¸€ä¸ªå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼Œè€ƒè™‘åˆ°æ¯ä¸ªç»„ä»¶ä¼šè¯·æ±‚ä¸åŒçš„æ–¹æ³•ï¼Œä¸”ç»„ä»¶å¸è½½ä¹Ÿåªæ¸…é™¤åœ¨è¿™ä¸ªç»„ä»¶å®ä¾‹è¿è¡Œæ—¶æ‰€å‘èµ·çš„é‚£äº›å¼‚æ­¥æ–¹æ³•ï¼Œï¼ˆä¸ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ï¼Œéœ€è¦ç»´æŠ¤ç»„ä»¶å†…éƒ¨çŠ¶æ€ï¼‰è¿™ç§éœ€æ±‚å°±å¾ˆç¬¦åˆ Hooks çš„è®¾è®¡ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ Hooks å°†è¿™ä¸€éƒ¨åˆ†é€»è¾‘æŠ½å‡ºï¼Œåœ¨å“ªä¸ªç»„ä»¶éœ€è¦å°±å¼•å…¥ä½¿ç”¨ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// useCancelTimer.js</span>
<span class="kd">const</span> <span class="nx">useCancelTimer</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">requests</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">([]);</span> <span class="c1">// å­˜å‚¨æ¯ä¸ªå¼‚æ­¥æ–¹æ³•æ ‡è¯†</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ç»„ä»¶å¸è½½æ—¶æ¸…é™¤</span>
      <span class="nx">requests</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">clearTimeout</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="nx">useCallback</span><span class="p">((</span><span class="nx">timer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ä½¿ç”¨è¯¥æ–¹æ³•åŒ…è£¹æ¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚</span>
    <span class="nx">requests</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Content.jsx</span>
<span class="kd">const</span> <span class="nx">Content</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">addTimer</span> <span class="o">=</span> <span class="nx">useCancelTimer</span><span class="p">();</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">setData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">({});</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">addTimer</span><span class="p">(</span><span class="nx">request</span><span class="p">());</span> <span class="c1">// ä½¿ç”¨è¯¥æ–¹æ³•åŒ…è£¹æ¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">reslove</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">setData</span><span class="p">({</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jace</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„è‡ªå®šä¹‰ Hooks ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œåœ¨ç»„ä»¶å†…ç»´æŠ¤ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚åˆ—è¡¨ï¼Œåœ¨ç»„ä»¶å¸è½½æ—¶å–æ¶ˆæ‰€æœ‰çš„å¼‚æ­¥æ“ä½œï¼Œè¿”å›çš„æ–¹æ³•å°±æ˜¯ç”¨æ¥è®°å½•å¼‚æ­¥è¯·æ±‚çš„ã€‚</p>

<h3 id="-userequest">ğŸŒ° useRequest</h3>

<p>ä¸Šè¿°æ¡ˆæ˜¯ä½¿ç”¨çš„è®¡æ—¶å™¨ï¼Œè¦å¤„ç†å…·ä½“ä¸šåŠ¡ä¸­æ‰€ä½¿ç”¨çš„å¼‚æ­¥è¯·æ±‚æ–¹æ³•ä¹Ÿå¤§å·®ä¸å·®ï¼ŒåŒæ ·çš„é€»è¾‘ï¼Œè¿™é‡Œå†åˆ†äº«ä¸€ä¸ªæˆ‘åŸºäº Axios æ¥å®ç°çš„æ¡ˆä¾‹ï¼šçº¿ä¸Šåœ°å€ <a href="https://codesandbox.io/s/react-hooks-iu15t?file=/src/hooks/useRequest.js">useRequest</a></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">useRequest</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">requests</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">({});</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">loading</span><span class="p">,</span> <span class="nx">setLoading</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span> <span class="c1">// é¡ºå•ç»´æŠ¤ä¸€ä¸ªç»„ä»¶å†…æ‰€éœ€è¦çš„ loading çŠ¶æ€</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ç»„ä»¶å¸è½½å–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œä¸­çš„å¼‚æ­¥è¯·æ±‚</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">current</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">requests</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">current</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span><span class="p">[</span><span class="nx">key</span><span class="p">]?.(</span><span class="dl">"</span><span class="s2">cancel</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">[</span>
    <span class="k">async</span> <span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">showLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// è§„å®šç»„ä»¶å†…æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ æ­¤æ–¹æ³•æ¥å‘é€ä»¥ä¾¿ç»´æŠ¤</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">showLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">!</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="nx">setLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">_id</span> <span class="o">=</span> <span class="nx">getRandomId</span><span class="p">();</span> <span class="c1">// éšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ID</span>
      <span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">(</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">config</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">cancelToken</span><span class="p">:</span> <span class="k">new</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">CancelToken</span><span class="p">((</span><span class="nx">cancel</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">requests</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="p">{</span>
              <span class="c1">// å­˜ä¸‹å–æ¶ˆæ¯ä¸ªå¼‚æ­¥è¯·æ±‚éœ€è¦çš„æ–¹æ³•</span>
              <span class="p">[</span><span class="nx">_id</span><span class="p">]:</span> <span class="nx">cancel</span><span class="p">,</span>
            <span class="p">});</span>
          <span class="p">}),</span>
        <span class="p">})</span>
      <span class="p">);</span>

      <span class="kd">let</span> <span class="nx">error</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">promise</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// è¿™é‡Œå› ä¸ºç»„ä»¶å·²ç»å¸è½½äº†ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸èµ°ä¸‹é¢çš„é€»è¾‘äº†</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nx">Axios</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">delete</span> <span class="nx">requests</span><span class="p">.</span><span class="nx">current</span><span class="p">[</span><span class="nx">_id</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">requests</span><span class="p">.</span><span class="nx">current</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">setLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="p">[</span><span class="nx">error</span><span class="p">,</span> <span class="nx">res</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">loading</span><span class="p">,</span>
  <span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="æœ€å">æœ€å</h2>

<p>æœ¬ç¯‡ä¸»è¦è¿˜æ˜¯é’ˆå¯¹ä¸šåŠ¡æ¥è®²ï¼Œåˆ—ä¸¾ä¸€äº›ä¸šåŠ¡ä¸­å¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼Œæˆ‘ä¹Ÿå¾ˆå–œæ¬¢å°†ä¸šåŠ¡é‡åˆ°çš„ä¸œè¥¿è¿›è¡Œåˆ†äº«ã€‚å¾ˆæ—©ä¹‹å‰å°±æ‰“ç®—æä¸€ä¸ªé’ˆå¯¹è‡ªå®šä¹‰ Hooks çš„å¼€æºåº“ï¼Œä¸è¿‡å‰é˜µå­å‘ç°é˜¿é‡Œå¥½åƒæœ‰ä¸€ä¸ªäº† ğŸ˜… <a href="https://github.com/alibaba/hooks">ahooks</a>ï¼Œè¿™åº”è¯¥æ˜¯æ›´åŸºç¡€æˆ–è€…æ›´é€šç”¨å‹çš„ä¸€äº› Hooks å°è£…ã€‚ç­‰æœ‰ç©ºå»ºä¸€ä¸ªæ›´åå‘ä¸šåŠ¡çš„ Hooks Demo åˆé›†ä»“åº“ä»¥ä¾›å­¦ä¹ ï¼Œå¯»æ‰¾çµæ„Ÿå§ã€‚ğŸ˜‹ æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚</p>

<p>æœ€åæ‰“ä¸ªå°å¹¿å‘Šï¼Œæ¬¢è¿é˜…è¯»æˆ‘çš„è¿™ç¯‡æ–‡ç«  <a href="https://juejin.im/post/6846687599017492488">JS å‡½æ•°å¼ç¼–ç¨‹&amp;é«˜é˜¶å‡½æ•°çš„åº”ç”¨</a> å¾ˆé€‚åˆæ–°æ‰‹æˆé•¿çš„å“¦ï¼Œä¹Ÿæ˜¯åŸºäºä¸šåŠ¡é€»è¾‘æ¥å†™çš„ï¼Œä¸€è¾¹å†™è‡ªå®šä¹‰ Hooks å°è£…ç»„ä»¶é€»è¾‘ï¼Œä¸€è¾¹å†™é«˜é˜¶å‡½æ•°å°è£…æ–¹æ³•é€»è¾‘ï¼Œä»£ç è´¨é‡ã€å¼€å‘æ•ˆç‡åŒå€æå‡ ğŸ˜‹ ã€‚</p>

<p>æœ‰é—®é¢˜æ¬¢è¿æé—®ï¼Œæœ‰æ–‡ç«  BUG æ¬¢è¿æŒ‡æ­£ï¼Œæ„Ÿè°¢é˜…è¯»ã€‚</p>
:ET